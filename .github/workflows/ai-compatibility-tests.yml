name: AI Compatibility Tests

on:
  push:
    branches: [main, develop]
    paths:
      - '.ai-iap/rules/**'
      - '.ai-iap/config.json'
  pull_request:
    branches: [main, develop]
    paths:
      - '.ai-iap/rules/**'
      - '.ai-iap/config.json'
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  validate-rules:
    name: Validate Rule Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          echo "Validating config.json..."
          jq empty .ai-iap/config.json
          
          echo "Validating config.schema.json..."
          jq empty .ai-iap/config.schema.json

      - name: Check markdown files
        run: |
          echo "Checking for broken markdown in rules..."
          find .ai-iap/rules -name "*.md" -type f | while read file; do
            echo "Checking $file"
            # Basic markdown validation
            if ! grep -q "^#" "$file"; then
              echo "ERROR: $file has no headings"
              exit 1
            fi
          done

      - name: Verify CRITICAL REQUIREMENTS exist
        run: |
          echo "Checking critical framework files for CRITICAL REQUIREMENTS..."
          critical_files=(
            ".ai-iap/rules/typescript/frameworks/react.md"
            ".ai-iap/rules/java/frameworks/spring-boot.md"
            ".ai-iap/rules/dotnet/frameworks/aspnetcore.md"
            ".ai-iap/rules/python/frameworks/fastapi.md"
            ".ai-iap/rules/typescript/frameworks/nextjs.md"
          )
          
          for file in "${critical_files[@]}"; do
            if [ -f "$file" ]; then
              if ! grep -q "CRITICAL REQUIREMENTS" "$file"; then
                echo "ERROR: $file missing CRITICAL REQUIREMENTS section"
                exit 1
              fi
              echo "âœ“ $file has CRITICAL REQUIREMENTS"
            fi
          done
